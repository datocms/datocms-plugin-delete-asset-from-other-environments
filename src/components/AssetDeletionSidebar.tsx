import { Button, Canvas, Spinner } from "datocms-react-ui";
import type { RenderUploadSidebarPanelCtx } from "datocms-plugin-sdk";
import { useEffect, useMemo, useState } from "react";
import { ApiError, buildClient, LogLevel } from "@datocms/cma-client-browser";
import type { EnvironmentInstancesTargetSchema } from "@datocms/cma-client/dist/types/generated/ApiTypes";
import { EnvItem } from "./EnvItem.tsx";
import { sortByEnvUpdateTime } from "../utils/sortByEnvUpdateTime.ts";

export const AssetDeletionSidebar = ({
  ctx,
}: {
  ctx: RenderUploadSidebarPanelCtx;
}) => {
  const {
    currentUserAccessToken,
    currentRole,
    upload: { id: uploadId },
    environment: currentEnv,
    site: {
      id: siteId,
      attributes: { internal_domain },
    },
  } = ctx;

  // TODO add permissions checks
  /*
  "currentRole": {
      "id": "account_role",
      "type": "role",
      "attributes": {
        "name": "Account role",
        "can_edit_site": true,
        "can_edit_schema": true,
        "can_manage_menu": true,
        "can_manage_users": true,
        "can_manage_webhooks": true,
        "can_manage_workflows": true,
        "can_manage_access_tokens": true,
        "can_manage_shared_filters": true,
        "can_manage_upload_collections": true,
        "can_manage_environments": true,
        "can_promote_environments": true,
        "can_manage_sso": true,
        "can_access_audit_log": true,
        "can_edit_environment": true,
        "can_edit_favicon": true,
        "can_manage_build_triggers": true,
        "environments_access": "all",
        "can_perform_site_search": true,
        "can_access_build_events_log": true,
        "positive_item_type_permissions": [
          {
            "item_type": null,
            "workflow": null,
            "on_stage": null,
            "to_stage": null,
            "action": "all",
            "on_creator": "anyone",
            "environment": "main",
            "locale": null,
            "localization_scope": "all"
          }
        ],
        "negative_item_type_permissions": [],
        "positive_upload_permissions": [
          {
            "action": "all",
            "on_creator": "anyone",
            "environment": "main",
            "localization_scope": "all",
            "locale": null
          }
        ],
        "negative_upload_permissions": [],
        "positive_build_trigger_permissions": [
          {
            "build_trigger": null
          }
        ],
        "negative_build_trigger_permissions": []
  
     */

  const [allEnvsInProject, setAllEnvsInProject] =
    useState<EnvironmentInstancesTargetSchema>([]);
  const [envsWithUpload, setEnvsWithUpload] =
    useState<EnvironmentInstancesTargetSchema>([]);
  const [loadingMessage, setLoadingMessage] = useState<string>();

  // Build the client once per token.
  const client = useMemo(() => {
    if (!currentUserAccessToken) return null;
    return buildClient({
      apiToken: currentUserAccessToken,
      logLevel: LogLevel.BASIC,
    });
  }, [currentUserAccessToken]);

  useEffect(() => {
    if (!client) return;

    (async () => {
      const discoveredEnvs = await client.environments.list();
      setAllEnvsInProject(discoveredEnvs);
    })();
  }, [client]);

  useEffect(() => {
    if (
      !currentUserAccessToken ||
      !allEnvsInProject ||
      !allEnvsInProject.length
    ) {
      return;
    }

    (async () => {
      setLoadingMessage(
        `Checking ${allEnvsInProject.length} environment(s) for this asset...`,
      );
      let envsWithUpload: EnvironmentInstancesTargetSchema = [];
      const lookups = allEnvsInProject.map(async (env) => {
        const client = buildClient({
          apiToken: currentUserAccessToken,
          environment: env.id,
        });

        try {
          const upload = await client.uploads.find(uploadId);
          if (upload) {
            envsWithUpload.push(env);
          }
        } catch (e) {
          if (
            e instanceof ApiError

          ) {
            if(e.errors[0].attributes.code === "NOT_FOUND") {
              // Do nothing; that env just doesn't have this image (expected behavior)
              return;
            }
            else {
              await ctx.alert(`Error: ${JSON.stringify(e.errors[0].attributes.details)}`);
              return;
            }
          } else {
            await ctx.alert(`Unhandled error. Please contact support@datocms.com for help.`)
            //@ts-expect-error The cause should be valid
            throw new Error("Unhandled error", { cause: e });
          }
        }
      });

      await Promise.all(lookups);
      setEnvsWithUpload(envsWithUpload.sort(sortByEnvUpdateTime));
      setLoadingMessage(undefined);
    })();
  }, [allEnvsInProject, currentUserAccessToken, uploadId]);

  const deleteFromAllEnvs = async () => {
    const confirm = await ctx.openConfirm({
      title: `Delete ${envsWithUpload.length} copies?`,
      content: `Are you sure? This is irreversible. Please make sure you have offline backups of this asset.`,
      choices: [
        {
          label: "Delete all",
          value: "deleteAll",
          intent: "negative",
        },
      ],
      cancel: { label: "Go back", value: "cancel" },
    }) as unknown as 'deleteAll' | 'cancel';

    if(confirm === 'deleteAll') {
      await ctx.alert('Deleting...');
    }
  };

  if (!currentUserAccessToken || !currentRole) {
    return (
      <Canvas ctx={ctx}>
        <p>You do not have blah blah</p>
      </Canvas>
    );
  }

  if (loadingMessage?.length) {
    return (
      <Canvas ctx={ctx}>
        <strong>
          <Spinner size={20} />
          {loadingMessage}
        </strong>
        <p>Please wait...</p>
      </Canvas>
    );
  }

  else {return (
    <Canvas ctx={ctx}>
      <p>Asset found in {envsWithUpload.length} out of {allEnvsInProject.length} environment(s):</p>
      <ol>
        {envsWithUpload.map((env) => (
          <EnvItem
            key={uploadId}
            env={env}
            currentEnv={currentEnv}
            uploadId={uploadId}
            projectDomain={internal_domain ?? `${siteId}.admin.datocms.com`}
          />
        ))}
      </ol>
      <Button onClick={deleteFromAllEnvs}>Delete this asset from all {envsWithUpload.length} env(s)</Button>
    </Canvas>
  )}
};
